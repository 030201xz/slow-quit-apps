name: "Copilot Setup Steps"

# 当工作流文件发生变更时自动运行以便验证,也可以通过 Actions 标签页手动测试
on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # 此作业必须命名为 `copilot-setup-steps`,否则不会被 Copilot 识别
  copilot-setup-steps:
    runs-on: ubuntu-latest

    # 设置最低必需权限
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set Environment Variables
        run: |
          # 设置 SKILLS_MCP_TOOLS_PATH 环境变量，写入 shell 配置实现持久化
          TOOLS_PATH="/home/runner/work/wf/wf/.skills-mcp"

          for RC_FILE in ~/.bashrc ~/.zshrc; do
            if [ -f "$RC_FILE" ]; then
              echo "" >> "$RC_FILE"
              echo "# Skills MCP 外部工具路径" >> "$RC_FILE"
              echo "export SKILLS_MCP_TOOLS_PATH=\"$TOOLS_PATH\"" >> "$RC_FILE"
            fi
          done

          # 同时写入 GITHUB_ENV 供后续步骤使用
          echo "SKILLS_MCP_TOOLS_PATH=$TOOLS_PATH" >> $GITHUB_ENV

      - name: Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Verify Bun installation
        run: |
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          bun --version

      - name: Install dependencies
        run: |
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          # CI 环境禁用 husky，避免 prepare 脚本失败
          HUSKY=0 bun install

      # 安装并构建所有 @x/* 内部包，确保其他包能正确引用
      # 由于 bunfig.toml 配置了 linker = "isolated"，需要先单独安装每个包的依赖
      # 使用 || true 允许单个包失败不影响整体流程
      - name: Install and build internal packages (@x/*)
        run: |
          export BUN_INSTALL="$HOME/.bun"
          export PATH="$BUN_INSTALL/bin:$PATH"
          # CI 环境禁用 husky，子包 install:pkg 时不触发 prepare 脚本
          export HUSKY=0

          # 显式列出所有 @x/* 包，单个失败不阻塞整体流程
          PACKAGES=(
            "@x/logger"
            "@x/config"
            "@x/skills-mcp"
            "@x/cron"
            "@x/consul-config"
            "@x/requests"
            "@x/zod2gql"
          )

          for pkg in "${PACKAGES[@]}"; do
            echo "::group::Building $pkg"
            bunx turbo run build:pkg --filter="$pkg" || echo "⚠️ $pkg build failed, continuing..."
            echo "::endgroup::"
          done

      # - name: Install GitHub CLI
      #   run: |
      #     curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      #     sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
      #     echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      #     sudo apt-get update
      #     sudo apt-get install gh -y

      # - name: Verify GitHub CLI installation
      #   run: gh --version

      # - name: Setup GitHub Token
      #   run: |
      #     echo "${{ secrets.GH_TOKEN }}" > ~/.github_token
      #     echo "GITHUB_TOKEN=${{ secrets.GH_TOKEN }}" >> $GITHUB_ENV
      #     gh auth login --with-token < ~/.github_token

      # - name: Verify GitHub CLI authentication
      #   run: gh auth status

      - name: Setup Git wrapper to block --no-verify
        run: |
          # 创建 git wrapper 脚本，禁止使用 --no-verify
          mkdir -p ~/.local/bin
          cat > ~/.local/bin/git-wrapper << 'EOF'
          #!/bin/bash
          # Git Wrapper - 拦截 --no-verify 参数

          REAL_GIT=$(which -a git | grep -v "git-wrapper" | head -1)
          [ -z "$REAL_GIT" ] && REAL_GIT="/usr/bin/git"

          if [ "$1" = "commit" ]; then
            for arg in "$@"; do
              if [ "$arg" = "--no-verify" ] || [ "$arg" = "-n" ]; then
                echo ""
                echo "╔════════════════════════════════════════════════════╗"
                echo "║  ❌ 禁止使用 --no-verify 绕过提交信息校验          ║"
                echo "╠════════════════════════════════════════════════════╣"
                echo "║  请按照规范格式编写 commit message                 ║"
                echo "║  运行 git commit 查看模板示例                      ║"
                echo "╚════════════════════════════════════════════════════╝"
                echo ""
                exit 1
              fi
            done
          fi

          exec "$REAL_GIT" "$@"
          EOF
          chmod +x ~/.local/bin/git-wrapper

          # 写入 shell 配置实现持久化
          ALIAS_LINE="alias git='~/.local/bin/git-wrapper'"
          for RC_FILE in ~/.bashrc ~/.zshrc; do
            if [ -f "$RC_FILE" ] && ! grep -q "git-wrapper" "$RC_FILE"; then
              echo "" >> "$RC_FILE"
              echo "# Git wrapper - 禁止使用 --no-verify 绕过 commit message 校验" >> "$RC_FILE"
              echo "$ALIAS_LINE" >> "$RC_FILE"
            fi
          done
